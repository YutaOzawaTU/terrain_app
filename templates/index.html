<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>3D Terrain Viewer</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<h1>3D 地形可視化 & STL 生成ツール</h1>

<input type="file" id="ncfile">
<button onclick="upload()">アップロードして表示</button>

<br><br>
Zスケール: <input type="number" id="zscale" value="1" step="0.1">
<button onclick="updateZ()">更新</button>

<div id="plot" style="width:100%;height:600px;"></div>

<button onclick="downloadSTL()">STLをダウンロード</button>

<script>
let LONS, LATS, Z;
let currentZ = 1;

function upload() {
    const file = document.getElementById("ncfile").files[0];
    const form = new FormData();
    form.append("ncfile", file);

    fetch("/api/upload_nc", { method:"POST", body:form })
        .then(r => r.json())
        .then(data => {
            LONS = data.lons;
            LATS = data.lats;
            Z = data.Z;
            draw();
        });
}

function draw() {
    const fig = {
        data:[{
            type:"surface",
            x:LONS,
            y:LATS,
            z:Z,
            colorscale:"Viridis"
        }],
        layout:{
            title:"3D Terrain",
            scene:{
                aspectratio:{x:1, y:1, z:currentZ}
            }
        }
    };
    Plotly.newPlot("plot", fig);
}

function updateZ() {
    currentZ = parseFloat(document.getElementById("zscale").value);
    draw();
}

function downloadSTL() {
    fetch("/api/export_stl", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            lons:LONS,
            lats:LATS,
            Z:Z,
            z_scale:currentZ
        })
    }).then(resp => resp.blob())
      .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "terrain.stl";
          a.click();
          URL.revokeObjectURL(url);
      });
}
</script>

<!-- ========================= -->
<!--       Footer Section       -->
<!-- ========================= -->
<footer style="
    width: 100%;
    padding: 20px 0;
    text-align: center;
    margin-top: 60px;
    border-top: 1px solid #ddd;
    font-size: 14px;
    color: #555;
">

    <!-- GEBCO 公式リンク -->
    <div style="margin-bottom: 10px;">
        標高データ提供: 
        <a href="https://download.gebco.net" target="_blank" style="color: #0066cc; text-decoration: none;">
            GEBCO公式サイト
        </a>
    </div>

    <!-- 濵田ゼミ SNS（note） -->
    <div style="margin-bottom: 10px;">
        濵田ゼミ公式 note:
        <a href="https://note.com/create_gbm" target="_blank" style="color: #0066cc; text-decoration: none;">
            https://note.com/create_gbm
        </a>
    </div>

    <!-- 固定の最終更新日 -->
    <div>
        最終更新日: 2025/11/13
    </div>
</footer>

</body>
</html>
